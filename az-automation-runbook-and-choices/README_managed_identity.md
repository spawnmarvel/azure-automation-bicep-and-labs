# Managed identities for Azure resources


What are managed identities?

At a high level, there are two types of identities: human and machine/non-human identities. Machine / non-human identities consist of device and workload identities. In Microsoft Entra, workload identities are applications, service principals, and managed identities.

System-assigned. Some Azure resources, such as virtual machines allow you to enable a managed identity directly on the resource. When you enable a system-assigned managed identity:

* A service principal of a special type is created in Microsoft Entra ID for the identity. The service principal is tied to the lifecycle of that Azure resource. When the Azure resource is deleted, Azure automatically deletes the service principal for you.

User-assigned. You may also create a managed identity as a standalone Azure resource. You can create a user-assigned managed identity and assign it to one or more Azure Resources. When you enable a user-assigned managed identity:

* A service principal of a special type is created in Microsoft Entra ID for the identity. The service principal is managed separately from the resources that use it.

https://learn.microsoft.com/en-us/entra/identity/managed-identities-azure-resources/


## Differences between system-assigned and user-assigned managed identities

![differences](https://github.com/spawnmarvel/azure-automation-bicep-and-labs/blob/main/az-automation-runbook-and-choices/images/managed_identity.png)


## Use managed identities for Azure resources

### Use managed identity directly

Service code running on your Azure compute resource uses either the Microsoft Authentication Library (MSAL) or Azure.Identity SDK to retrieve a managed identity token from Entra ID backed by the managed identity. 

This token acquisition doesn't require any ***secrets*** and is automatically authenticated based on the environment where the code runs. As long as the managed identity is authorized, the service code can access downstream dependencies that support Entra ID authentication.

Example

```ps1
# ---------------------------------------------------------------------------------
# 2. HARDCODED SETTINGS
# ---------------------------------------------------------------------------------
$ClientId       = "xxxxxxxxxxxxxxxxxxxx" # ID of 'name-managedidentity'
$TenantId       = "xxxxxxxxxxxxxxxxxxxx" 
$SubscriptionId = "xxxxxxxxxxxxxxxxxxxx" 
```

Hardcoding these specific IDs is still secure, and you do not need a Key Vault for them.

Here is why that "Service code" snippet changes the game for your work:

1. The IDs are not "Secrets"
- The ClientId, TenantId, and SubscriptionId are just addresses.

Analogy: Your ClientId is like your home address. Anyone can see it on an envelope, but they can't get into your house without your physical key.

In Azure: The "Physical Key" is the Managed Identity Token. This token is never in your code; it is generated by Azure internally and handed to your script only because your script is running inside your authorized Automation Account.


2. The Environment is the Authenticator
- The snippet says: "This token acquisition doesn't require any secrets and is automatically authenticated based on the environment where the code runs."

If a hacker stole your script and tried to run it from their laptop using your ClientId, it would fail.

Azure checks: "Is this request coming from the specific Automation Account that 'name-managedidentity' is assigned to?" If the answer is no, the ClientId is useless.

3. Why you don't need Key Vault here
- Usually, we use Key Vault to hide Client Secrets or Passwords. Since Managed Identities have zero passwords, there is nothing sensitive to hide.

Hardcoding the IDs actually makes your script more resilient. If Key Vault has an outage or a latency spike, your script can still start because it already knows where to "knock" (the IDs) to get its token.


Managed Identities do not work from local machines. The snippet you referenced says the token is retrieved "based on the environment where the code runs." Because your local laptop isn't an "Azure compute resource" (like a VM or a Runbook worker), it doesn't have the internal plumbing to talk to the Entra ID identity service.

![compare old and new way](https://github.com/spawnmarvel/azure-automation-bicep-and-labs/blob/main/az-automation-runbook-and-choices/images/managed_identity_compare.png)

One Small Best Practice

While hardcoding is safe, if you ever plan to use this script across different environments (Prod vs. Dev), you can move those IDs to Automation Variables (under Shared Resources > Variables) instead of a Key Vault. This isn't for securityâ€”it's just so you can change the ID in one place without editing the script code.